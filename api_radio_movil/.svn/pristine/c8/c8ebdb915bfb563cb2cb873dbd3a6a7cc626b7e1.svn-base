
import { generateError } from '../utils/errorsUtil.js';
import { pool } from '../bd.js';
import { query, response } from 'express';
import { printQuery, encriptador } from '../utils/dbUtil.js';
import { formatDB } from '../utils/dateUtil.js';

const sameColumnsSelected = `
      p.cve_control,
      DATE_FORMAT(p.fec_propuesta, '%d/%m/%Y') AS fec_propuesta,
      p.importe,
      p.id_divisa,
      p.concepto,
      p.no_empresa,
      p.desc_empresa,
      p.id_banco,
      p.desc_banco,
      p.id_chequera,
      p.nivel_autorizacion,
      p.usuario_uno,
      p.usuario_dos,
      p.usuario_tres,
      p.status,
      COALESCE((SELECT clave_usuario FROM usuarios WHERE id_usuario = p.usuario_uno),'') AS nombre_usuario_uno,
      COALESCE((SELECT clave_usuario FROM usuarios WHERE id_usuario = p.usuario_dos),'') AS nombre_usuario_dos,
      COALESCE((SELECT clave_usuario FROM usuarios WHERE id_usuario = p.usuario_tres),'') AS nombre_usuario_tres
`
export const getPropuestasByUser = async (req, res) => {
  try {
    const { clave_usuario } = req.params;

    const query = `
      SELECT 
      ${sameColumnsSelected}
      FROM propuestas p
      JOIN usuarios u ON u.clave_usuario = ? AND FIND_IN_SET(p.no_empresa, u.empresas) > 0
      WHERE p.usuario_uno IS NOT NULL
    `;
    // printQuery("getPropuestasByUser", query, clave_usuario);
    const [rows] = await pool.query(query, clave_usuario);

    // Respuesta exitosa
    res.json(rows);

  } catch (error) {
    console.error("Error en getPropuestasByUser:", error);
    return res.status(500).json({ SUCCESS: false, MESSAGE: "Error en el servidor" });
  }
}

export const getPropuestasPendientesByUser = async (req, res) => {
  try {
    const { clave_usuario } = req.params;

    const query = `
      SELECT 
      ${sameColumnsSelected}
      FROM propuestas p
      JOIN usuarios u ON u.clave_usuario = ? AND FIND_IN_SET(p.no_empresa, u.empresas) > 0
      WHERE p.usuario_uno IS NOT NULL 
      AND (CASE WHEN p.nivel_autorizacion = 3 AND (p.usuario_dos IS NULL OR p.usuario_tres IS NULL) THEN 1 ELSE 0 END) = 1
      AND (CASE 
			      WHEN p.nivel_autorizacion = 2 AND p.usuario_dos IS NULL THEN 1
		        WHEN p.nivel_autorizacion <> 2 THEN 1 ELSE 0 END) = 1
    `;//AND (p.usuario_dos IS NULL OR p.usuario_tres IS NULL)
    // printQuery("getPropuestasPendientesByUser", query, clave_usuario);
    const [rows] = await pool.query(query, clave_usuario);

    // Respuesta exitosa
    res.json(rows);

  } catch (error) {
    console.error("Error en getPropuestasPendientesByUser:", error);
    return res.status(500).json({ SUCCESS: false, MESSAGE: "Error en el servidor" });
  }
}

export const autorizarPropuestas = async (req, res) => {//ACTUALIZA CON PROPUESTAS DE LA APP MOVIL
  const connection = await pool.getConnection(); //la conexion se usa para poder trabajar con transacciones
  try {
    const { propuestas, id_usuario } = req.body;
    // console.log({
    //   propuestas,
    //   id_usuario
    // })

    const clavesControl = propuestas.map(propuesta => "'" + propuesta.cve_control + "'").join(",")

    //VALIDAR SI ALGUNA  TIENE NULL el usuario_uno__________________________________
    let queryValidacion = `
        SELECT count(*)  AS count, cve_control FROM propuestas WHERE cve_control IN(${clavesControl}) AND usuario_uno IS NULL
      `;
    // printQuery("autorizarPropuestas_1", queryValidacion);
    const [rows] = await connection.query(queryValidacion);
    if (rows[0].count > 0) {
      return res.status(201).json({ SUCCESS: false, MESSAGE: `La propuesta ${rows[0].cve_control} no tiene la primera autorización` });
    }

    //VALIDAR SI HAN CAMBIADO?
    for (let propuesta of propuestas) {
      const queryValidacion2 = `
        SELECT 
          cve_control,
          importe,
          id_chequera,
          nivel_autorizacion,
          usuario_uno,
          usuario_dos,
          usuario_tres
        FROM propuestas
        WHERE cve_control = '${propuesta.cve_control}'
      `;

      // printQuery("autorizarPropuestas_2", queryValidacion2);
      const [rows] = await connection.query(queryValidacion2);

      if (rows.length === 0) {
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `La propuesta ${propuesta.cve_control} no existe en la base de datos, favor de revisarla nuevamente`,
        });
      }
      const row = rows[0];
      const camposInvalidos = [];

      if (row.importe !== propuesta.importe) camposInvalidos.push('Importe');
      if (row.id_chequera !== propuesta.id_chequera) camposInvalidos.push('Chequera');
      if (row.nivel_autorizacion !== propuesta.nivel_autorizacion) camposInvalidos.push('Nivel autorización');
      if (row.usuario_uno !== propuesta.usuario_uno) camposInvalidos.push('Usuario uno');
      if (row.usuario_dos !== propuesta.usuario_dos) camposInvalidos.push('Usuario dos');
      if (row.usuario_tres !== propuesta.usuario_tres) camposInvalidos.push('Usuario tres');
      if (camposInvalidos.length > 0) {
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `La propuesta ${propuesta.cve_control} tiene diferencias en los campos: ${camposInvalidos.join(', ')}, favor de revisarla nuevamente`,
        });
      }
    }

    //3 - ACTUALLIZAR________________________________________________-
    let updates = new Array();
    for (const propuesta of propuestas) {

      //VALIDA NIVEL AUTORIZACION
      let usuarioCampo = "";
      if (propuesta.nivel_autorizacion === 1) {
        usuarioCampo = null;
      } else if (propuesta.nivel_autorizacion === 2) {
        usuarioCampo = propuesta.usuario_dos === null ? 'usuario_dos' : null;
      } else if (propuesta.nivel_autorizacion === 3) {
        usuarioCampo = propuesta.usuario_dos === null ? 'usuario_dos' :
          propuesta.usuario_tres === null ? 'usuario_tres' : null;
      }
      if (usuarioCampo === null)
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `La propuesta con clave de control ${propuesta.cve_control} ya tiene su número maximo de autorizaciones (${propuesta.nivel_autorizacion})`,
        });

      //TODO VALIDAR SI TIENE FACULTAD MANCOMUNAD - SI HA AUTORIZADO ALGUN NIVEL ANTERIOR MANDAR ERROR
      if (propuesta.usuario_uno === id_usuario || propuesta.usuario_dos === id_usuario) {
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `No puedes tener más de una autorización en la propuesta con clave de control ${propuesta.cve_control}`,
        });
      }

      updates.push({
        query: `UPDATE propuestas SET status = 1, ${usuarioCampo} = ? WHERE cve_control = ?`,
        params: [id_usuario, propuesta.cve_control],
      });
    }


    await connection.beginTransaction();
    for (const update of updates) {
      // printQuery("autorizarPropuestas_3", update.query, update.params)
      await connection.query(update.query, update.params);
    }

    // Respuesta exitosa
    await connection.commit();
    res.json({ SUCCESS: true, MESSAGE: "" });

  } catch (error) {
    console.error("Error en autorizarPropuestas:", error);
    await connection.rollback();
    return res.status(500).json({ SUCCESS: false, MESSAGE: "Error en el servidor" });
  } finally {
    connection.release();
  }
}
export const desautorizarPropuestas = async (req, res) => {//ACTUALIZA CON PROPUESTAS DE LA APP MOVIL
  const connection = await pool.getConnection(); //la conexion se usa para poder trabajar con transacciones
  try {
    const { propuestas, id_usuario } = req.body;
    console.log({
      propuestas,
      id_usuario
    })

    // const clavesControl = propuestas.map(propuesta => "'" + propuesta.cve_control + "'").join(",")

    //VALIDAR SI ALGUNA  TIENE NULL el usuario_uno__________________________________
    // let queryValidacion = `
    //     SELECT count(*)  AS count, cve_control FROM propuestas WHERE cve_control IN(${clavesControl}) AND usuario_uno IS NULL
    //   `;
    // printQuery("autorizarPropuestas_1", queryValidacion);
    // const [rows] = await connection.query(queryValidacion);
    // if (rows[0].count > 0) {
    //   return res.status(201).json({ SUCCESS: false, MESSAGE: `La propuesta ${rows[0].cve_control} no tiene la primera autorización` });
    // }

    //1-VALIDAR SI HAN CAMBIADO?
    for (let propuesta of propuestas) {
      const queryValidacion2 = `
        SELECT 
          cve_control,
          importe,
          id_chequera,
          nivel_autorizacion,
          usuario_uno,
          usuario_dos,
          usuario_tres
        FROM propuestas
        WHERE cve_control = '${propuesta.cve_control}'
      `;

      // printQuery("autorizarPropuestas_1", queryValidacion2);
      const [rows] = await connection.query(queryValidacion2);

      if (rows.length === 0) {
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `La propuesta ${propuesta.cve_control} no existe en la base de datos, favor de revisarla nuevamente`,
        });
      }
      const row = rows[0];
      const camposInvalidos = [];

      if (row.importe !== propuesta.importe) camposInvalidos.push('Importe');
      if (row.id_chequera !== propuesta.id_chequera) camposInvalidos.push('Chequera');
      if (row.nivel_autorizacion !== propuesta.nivel_autorizacion) camposInvalidos.push('Nivel autorización');
      if (row.usuario_uno !== propuesta.usuario_uno) camposInvalidos.push('Usuario uno');
      if (row.usuario_dos !== propuesta.usuario_dos) camposInvalidos.push('Usuario dos');
      if (row.usuario_tres !== propuesta.usuario_tres) camposInvalidos.push('Usuario tres');
      if (camposInvalidos.length > 0) {
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `La propuesta ${propuesta.cve_control} tiene diferencias en los campos: ${camposInvalidos.join(', ')}, favor de revisarla nuevamente`,
        });
      }

      //VALIDAR SI EL USUARIO 1 ES NULL
      if (propuesta.usuario_uno === null) {
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `Nada para desautorizar en la propuesta ${propuesta.cve_control}`,
        });
      }

      //VALIDA SI TIENE NIVEL 1 AUTORIZACION
      if (propuesta.nivel_autorizacion === 1) {
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `No puedes desautorizar propuestas con nivel 1 de autorización - propuesta ${propuesta.cve_control}`,
        });
      }


      //VALIDAR SI EL ULTIMO USUARIO AUTORIZADO 3 Ó 2 SON DEL USUARIO DESAUTORIZADOR
      if (row.usuario_tres !== null) {
        if (row.usuario_tres !== id_usuario)
          return res.status(201).json({
            SUCCESS: false,
            MESSAGE: `No puedes desautorizar la propuesta ${propuesta.cve_control} ya que no eres el último autorizador`,
          });
      } else if (row.usuario_dos !== null) {
        if (row.usuario_dos !== id_usuario)
          return res.status(201).json({
            SUCCESS: false,
            MESSAGE: `No puedes desautorizar la propuesta ${propuesta.cve_control} ya que no eres el último autorizador`,
          });
      }
      // if ((row.usuario_tres !== null && row.usuario_tres !== id_usuario) || (row.usuario_dos !== null && row.usuario_dos !== id_usuario)) {
      //   return res.status(201).json({
      //     SUCCESS: false,
      //     MESSAGE: `No puedes desautorizar la propuesta ${propuesta.cve_control} ya que no eres el último autorizador`,
      //   });
      // } 
      else if (row.usuario_tres === null && row.usuario_uno === null) {
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `No puedes desautorizar el nivel 1 - propuesta ${propuesta.cve_control}`,
        });
      }
    }

    //2 - ACTUALLIZAR________________________________________________-
    let updates = new Array();
    for (const propuesta of propuestas) {

      //VALIDA NIVEL AUTORIZACION
      let usuarioCampo = null;
      if (propuesta.nivel_autorizacion === 2) {
        usuarioCampo = propuesta.usuario_dos !== null ? "usuario_dos" : null
      } else if (propuesta.nivel_autorizacion === 3) {
        usuarioCampo = propuesta.usuario_tres !== null ? 'usuario_tres' :
          propuesta.usuario_tres !== null ? 'usuario_dos' : null;
      }
      if (usuarioCampo === null)
        return res.status(201).json({
          SUCCESS: false,
          MESSAGE: `Error en validar la propuesta ${propuesta.cve_control}`,
        });

      updates.push({
        query: `UPDATE propuestas SET status = 1, ${usuarioCampo} = null WHERE cve_control = ?`,
        params: [propuesta.cve_control],
      });
    }


    await connection.beginTransaction();
    for (const update of updates) {
      // printQuery("desautorizarPropuestas_2", update.query, update.params)
      await connection.query(update.query, update.params);
    }

    // Respuesta exitosa
    await connection.commit();
    res.json({ SUCCESS: true, MESSAGE: "" });

  } catch (error) {
    console.error("Error en desautorizarPropuestas:", error);
    await connection.rollback();
    return res.status(500).json({ SUCCESS: false, MESSAGE: "Error en el servidor" });
  } finally {
    connection.release();
  }
}
export const autorizarPropuestas2 = async (req, res) => {
  const connection = await pool.getConnection(); //la conexion se usa para poder trabajar con transacciones
  try {
    const { propuestas, id_usuario } = req.body;

    // Obtenemos las claves de control
    const clavesControl = propuestas.map(propuesta => propuesta.cve_control);


    // Validar si alguna propuesta no tiene `usuario_uno`
    const [validacion1] = await connection.query(
      `SELECT cve_control FROM propuestas 
       WHERE cve_control IN (?) AND usuario_uno IS NULL`,
      [clavesControl]
    );
    if (validacion1.length > 0) {
      return res.status(400).json({
        SUCCESS: false,
        MESSAGE: `La propuesta ${validacion1[0].cve_control} no tiene la primera autorización`,
      });
    }

    // Validar si alguna propuesta ha cambiado
    const cambios = propuestas.map(propuesta => [
      propuesta.cve_control,
      propuesta.importe,
      propuesta.id_chequera,
      propuesta.nivel_autorizacion,
      propuesta.usuario_uno,
      propuesta.usuario_dos,
      propuesta.usuario_tres,
    ]);

    const [validacion2] = await connection.query(
      `SELECT cve_control FROM propuestas 
       WHERE (cve_control, importe, id_chequera, nivel_autorizacion, usuario_uno, usuario_dos, usuario_tres) 
       NOT IN (?)`,
      [cambios]
    );

    if (validacion2.length > 0) {
      return res.status(400).json({
        SUCCESS: false,
        MESSAGE: `La propuesta ${validacion2[0].cve_control} ha cambiado en alguno de sus campos, favor de revisarla nuevamente`,
      });
    }

    // Preparar actualizaciones
    const updates = propuestas.map(propuesta => {
      const usuarioCampo = propuesta.usuario_dos === null ? 'usuario_dos' : 'usuario_tres';
      return {
        query: `UPDATE propuestas SET status = 1, ${usuarioCampo} = ? WHERE cve_control = ?`,
        params: [id_usuario, propuesta.cve_control],
      };
    });

    // Ejecutar todas las actualizaciones
    // Iniciar transacción
    await connection.beginTransaction();

    for (const update of updates) {
      await connection.query(update.query, update.params);
    }

    // Confirmar transacción
    await connection.commit();

    res.json({ SUCCESS: true, MESSAGE: "" });

  } catch (error) {
    await connection.rollback();
    console.error("Error en autorizarPropuestas2:", error);
    return res.status(500).json({ SUCCESS: false, MESSAGE: "Error en el servidor" });
  } finally {
    connection.release();
  }
}